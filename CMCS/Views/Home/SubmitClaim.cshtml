@model CMCS.Models.ClaimSubmissionViewModel

@{
    ViewData["Title"] = "Submit New Claim";
}

<div class="row">
    <div class="col-md-12">
        <h1 class="text-light">Submit New Claim</h1>
        <p class="text-muted">Complete the form below to submit a new monthly claim</p>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row mt-4 mb-5">
    <div class="col-md-8">
        <div class="card bg-dark text-light">
            <div class="card-header bg-secondary">
                <h5 class="mb-0 text-light">Claim Information</h5>
            </div>
            <div class="card-body">
                <form asp-action="SubmitClaim" method="post" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="form-group mb-3">
                        <label asp-for="Period" class="form-label text-light"></label>
                        <input asp-for="Period" class="form-control bg-dark text-light" placeholder="e.g., October 2025" />
                        <span asp-validation-for="Period" class="text-danger"></span>
                        <div class="form-text text-light">Enter the month and year for which you are claiming</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Workload" class="form-label text-light"></label>
                                <input asp-for="Workload" class="form-control bg-dark text-light" />
                                <span asp-validation-for="Workload" class="text-danger"></span>
                                <div class="form-text text-light">Total hours worked during the claim period</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="HourlyRate" class="form-label text-light"></label>
                                <input asp-for="HourlyRate" class="form-control bg-dark text-light" readonly />
                                <div class="form-text text-light">Lecturer's hourly rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label text-light">Total Amount</label>
                        <div class="form-control bg-secondary text-light" id="totalAmountDisplay">@Model.TotalAmount.ToString("C")</div>
                        <div class="form-text text-light">Calculated as Workload × Hourly Rate</div>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Description" class="form-label text-light"></label>
                        <textarea asp-for="Description" class="form-control bg-dark text-light" rows="3" placeholder="Brief description of work performed..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-4">
                        <label asp-for="Documents" class="form-label text-light">Supporting Documents (Optional)</label>
                        <input asp-for="Documents" type="file" class="form-control bg-dark text-light" multiple
                               accept=".pdf,.docx,.xlsx,.doc,.xls,.jpg,.jpeg,.png" />
                        <span asp-validation-for="Documents" class="text-danger"></span>
                        <div class="form-text text-light">
                            Upload timesheets, attendance records, or other supporting documents (PDF, Excel, Word, Images).
                            <strong>Optional</strong> - you can submit claims without documents.
                        </div>
                    </div>

                    <!-- SUBMIT BUTTON - This was missing -->
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Submit Claim
                        </button>
                        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary btn-lg">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-dark text-light">
            <div class="card-header bg-secondary">
                <i class="bi bi-info-circle"></i> Claim Guidelines
            </div>
            <div class="card-body">
                <h6 class="card-title text-light">Before submitting, please ensure:</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-dark text-light border-secondary">All fields are completed accurately</li>
                    <li class="list-group-item bg-dark text-light border-secondary">Workload hours are correctly calculated</li>
                    <li class="list-group-item bg-dark text-light border-secondary">Claim period is specified correctly</li>
                    <li class="list-group-item bg-dark text-light border-secondary">Supporting documents are uploaded if available</li>
                </ul>
                <div class="mt-3">
                    <h6 class="text-light">Need help?</h6>
                    <p class="card-text text-light">Contact the administration office at <a href="mailto:admin@example.com" class="text-pink">admin@example.com</a> or call (012) 345-6789</p>
                </div>
            </div>
        </div>

        <div class="card bg-dark text-light mt-3">
            <div class="card-header bg-secondary">
                <i class="bi bi-clock-history"></i> Recent Claims
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <small class="text-success">CL-0015 - October 2025 - R6,250.00</small><br>
                        <small class="text-muted">Approved • 2025-10-15</small>
                    </div>
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <small class="text-warning">CL-0002 - October 2025 - R7,250.00</small><br>
                        <small class="text-muted">Pending • 2025-10-13</small>
                    </div>
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <small class="text-danger">CL-0001 - October 2025 - R5,250.00</small><br>
                        <small class="text-muted">Rejected • 2025-10-16</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // AUTO-CALCULATION FEATURE - POE REQUIREMENT
        document.addEventListener('DOMContentLoaded', function() {
            const workloadInput = document.getElementById('Workload');
            const hourlyRateInput = document.getElementById('HourlyRate');
            const totalAmountDisplay = document.getElementById('totalAmountDisplay');

            function calculateTotal() {
                const workload = parseFloat(workloadInput.value) || 0;
                const hourlyRate = parseFloat(hourlyRateInput.value) || 0;
                const totalAmount = workload * hourlyRate;

                // Update display
                totalAmountDisplay.textContent =
                    new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(totalAmount);
            }

            // Calculate on input change
            workloadInput.addEventListener('input', calculateTotal);
            hourlyRateInput.addEventListener('input', calculateTotal);

            // VALIDATION CHECKS - POE REQUIREMENT
            workloadInput.addEventListener('blur', function() {
                const workload = parseFloat(this.value) || 0;
                if (workload < 0.1) {
                    this.setCustomValidity('Workload must be at least 0.1 hours');
                } else if (workload > 200) {
                    this.setCustomValidity('Workload cannot exceed 200 hours');
                } else {
                    this.setCustomValidity('');
                }
            });

            // Initial calculation
            calculateTotal();
        });

        // FILE VALIDATION - POE REQUIREMENT
        document.getElementById('Documents').addEventListener('change', function() {
            const files = this.files;
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'image/jpeg', 'image/png'];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Size validation
                if (file.size > maxSize) {
                    alert(`File "${file.name}" exceeds the 5MB size limit.`);
                    this.value = '';
                    break;
                }

                // Type validation
                if (!allowedTypes.includes(file.type)) {
                    alert(`File "${file.name}" is not a supported file type.`);
                    this.value = '';
                    break;
                }
            }
        });
    </script>
}

<style>
    .text-pink {
        color: var(--pink-primary) !important;
    }

    .form-control:focus {
        border-color: var(--pink-primary);
        box-shadow: 0 0 0 0.2rem rgba(236, 72, 153, 0.25);
    }

    .btn-primary {
        background: var(--gradient-pink);
        border-color: var(--pink-primary);
    }

        .btn-primary:hover {
            background: var(--pink-secondary);
            border-color: var(--pink-dark);
            transform: translateY(-2px);
        }

    .btn-lg {
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
    }
</style>